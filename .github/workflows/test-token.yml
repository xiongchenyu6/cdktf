name: Test Cloudflare Token Configuration

on:
  workflow_dispatch:

jobs:
  test-token:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Check if CLOUDFLARE_API_TOKEN secret exists
        run: |
          if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            echo "‚ùå CLOUDFLARE_API_TOKEN secret is not set in GitHub repository secrets"
            echo "Please add it at: https://github.com/xiongchenyu6/cdktf/settings/secrets/actions"
            exit 1
          else
            echo "‚úÖ CLOUDFLARE_API_TOKEN secret exists"
            echo "Token length: $(echo -n '${{ secrets.CLOUDFLARE_API_TOKEN }}' | wc -c) characters"

            # Check if it's exactly 40 characters
            TOKEN_LENGTH=$(echo -n '${{ secrets.CLOUDFLARE_API_TOKEN }}' | wc -c)
            if [ "$TOKEN_LENGTH" -eq 40 ]; then
              echo "‚úÖ Token is 40 characters long (correct length)"
            else
              echo "‚ùå Token is $TOKEN_LENGTH characters long (should be 40)"
              echo "Please check your Cloudflare API token"
              exit 1
            fi
          fi

      - uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Install dependencies
        run: yarn install

      - name: Generate module and provider bindings
        run: npx cdktf-cli get

      - name: Test token with Cloudflare API directly
        run: |
          echo "Testing Cloudflare API token..."
          response=$(curl -s -X GET "https://api.cloudflare.com/client/v4/user/tokens/verify" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json")

          echo "API Response: $response"

          if echo "$response" | grep -q '"success":true'; then
            echo "‚úÖ Token is valid and working with Cloudflare API"
          else
            echo "‚ùå Token validation failed. Please check:"
            echo "1. Token is valid and not expired"
            echo "2. Token has the correct permissions"
            echo "3. Token is from the correct Cloudflare account"
            exit 1
          fi

      - name: Check Terraform Cloud variable configuration
        run: |
          echo ""
          echo "üìã IMPORTANT: Terraform Cloud Variable Setup"
          echo "============================================"
          echo ""
          echo "Since you're using Terraform Cloud, you also need to set the variable there:"
          echo ""
          echo "1. Go to: https://app.terraform.io/app/autolife-robotics/cdktf/variables"
          echo "2. Add a new Terraform Variable:"
          echo "   - Key: cloudflare_api_token"
          echo "   - Value: Your Cloudflare API token (same as GitHub secret)"
          echo "   - Category: Terraform variable (not environment variable)"
          echo "   - Sensitive: ‚úì (check this box)"
          echo ""
          echo "Without this, Terraform Cloud won't have access to the token!"
          echo ""