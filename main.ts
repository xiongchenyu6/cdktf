/*
 * Provider bindings are generated by running `cdktf get`.
 * See https://cdk.tf/provider-generation for more details.
 */
import { DnsRecord } from "./.gen/providers/cloudflare/dns-record";
import { CloudflareProvider } from "./.gen/providers/cloudflare/provider";
import { Zone } from "./.gen/providers/cloudflare/zone";

import { Construct } from "constructs";
import { App, TerraformStack, CloudBackend, NamedCloudWorkspace, VariableType, TerraformVariable } from "cdktf";

export class MyStack extends TerraformStack {
  constructor(scope: Construct, id: string) {
    super(scope, id);

    /*Terraform Variables are not always the best fit for getting inputs in the context of Terraform CDK.
You can read more about this at https://cdk.tf/variables*/
    const cloudflareApiToken = new TerraformVariable(
      this,
      "cloudflare_api_token",
      {
        type: VariableType.STRING,
      }
    );

    function createZone(scope: Construct, name: string, zoneName: string) {
      return new Zone(scope, name, {
        account: { id: "2764ae0fd9a5cb92c9ac67708620e54c" },
        name: zoneName,
      });
    }

    function createDnsRecord(
      scope: Construct,
      name: string,
      zone: Zone,
      recordName: string,
      content: string,
      proxied: boolean
    ) {
      return new DnsRecord(scope, name, {
        content,
        name: recordName,
        proxied,
        ttl: 1,
        type: "A",
        zoneId: zone.id,
      });
    }

    function createCnameRecord(
      scope: Construct,
      name: string,
      zone: Zone,
      recordName: string,
      content: string
    ) {
      return new DnsRecord(scope, name, {
        content,
        name: recordName,
        proxied: false,
        ttl: 1,
        type: "CNAME",
        zoneId: zone.id,
      });
    }

    // Provider must be created BEFORE resources
    new CloudflareProvider(this, "cloudflare", {
      apiToken: cloudflareApiToken.stringValue,
    });

    // Create zones with correct variable names
    const autolifeAi = createZone(this, "autolife-ai", "autolife.ai");
    createZone(this, "autolifedpdnsorg", "autolife.dpdns.org");
    createZone(this, "xiongchenyudpdnsorg", "xiongchenyu.dpdns.org");

    createDnsRecord(this, "frp_dashboard_autolife", autolifeAi, "frp-dashboard", "138.2.95.174", false);
    createDnsRecord(this, "mainpage_autolife", autolifeAi, "autolife-robotics.me", "138.2.95.174", true);
    createDnsRecord(this, "mngt_autolife", autolifeAi, "mngt", "138.2.95.174", false);
    createDnsRecord(this, "netbird_autolife", autolifeAi, "netbird", "138.2.95.174", false);
    createDnsRecord(this, "rust-server_autolife", autolifeAi, "rust-server", "138.2.95.174", false);
    createDnsRecord(this, "vr_sg_autolife", autolifeAi, "vr-sg", "138.2.95.174", false);
    createDnsRecord(this, "www_autolife", autolifeAi, "www", "138.2.95.174", true);
    createDnsRecord(this, "api", autolifeAi, "api", "138.2.95.174", false);
    createCnameRecord(this, "freeman_cname", autolifeAi, "freeman", "cname.vercel-dns.com.");
    createDnsRecord(this, "kanidm", autolifeAi, "kanidm", "213.35.97.233", false);

  }
}

const app = new App({
  skipValidation: true
});

const stack = new MyStack(app, "cdktf");

new CloudBackend(stack, {
  hostname: "app.terraform.io",
  organization: "autolife-robotics",
  workspaces: new NamedCloudWorkspace("cdktf"),
});

app.synth();
